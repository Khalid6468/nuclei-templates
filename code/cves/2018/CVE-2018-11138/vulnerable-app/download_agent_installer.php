<?php
// Quest KACE System Management Appliance - Vulnerable download_agent_installer.php
// This simulates the vulnerable endpoint for CVE-2018-11138

// Set content type
header('Content-Type: text/html; charset=utf-8');

// Check if this is a POST request
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $platform = $_POST['platform'] ?? '';
    $custom_install_options = $_POST['custom_install_options'] ?? '';
    
    // Vulnerable code - command injection in custom_install_options
    if (!empty($custom_install_options)) {
        // This is the vulnerable part - command injection
        $command = "echo 'Installing agent for platform: " . $platform . "' " . $custom_install_options;
        
        // Execute the command (this is the vulnerability)
        $output = shell_exec($command);
        
        // Return the output
        echo "<html><head><title>KACE Agent Installer</title></head><body>";
        echo "<h1>Quest KACE System Management Appliance</h1>";
        echo "<h2>Agent Installation</h2>";
        echo "<p><strong>Platform:</strong> " . htmlspecialchars($platform) . "</p>";
        echo "<p><strong>Install Options:</strong> " . htmlspecialchars($custom_install_options) . "</p>";
        echo "<p><strong>Output:</strong></p>";
        echo "<pre>" . htmlspecialchars($output) . "</pre>";
        echo "<p><em>Note: This is a vulnerable test environment for CVE-2018-11138</em></p>";
        echo "</body></html>";
    } else {
        echo "<html><head><title>KACE Agent Installer</title></head><body>";
        echo "<h1>Quest KACE System Management Appliance</h1>";
        echo "<h2>Agent Installation</h2>";
        echo "<p>No custom install options provided.</p>";
        echo "</body></html>";
    }
} else {
    // Show form for GET requests
    echo "<html><head><title>KACE Agent Installer</title></head><body>";
    echo "<h1>Quest KACE System Management Appliance</h1>";
    echo "<h2>Agent Installation</h2>";
    echo "<form method='POST' action='download_agent_installer.php'>";
    echo "<p><label>Platform: <input type='text' name='platform' value='linux'></label></p>";
    echo "<p><label>Custom Install Options: <input type='text' name='custom_install_options' placeholder=';id;echo+'></label></p>";
    echo "<p><input type='submit' value='Install Agent'></p>";
    echo "</form>";
    echo "<p><em>This is a vulnerable test environment for CVE-2018-11138</em></p>";
    echo "</body></html>";
}
?> 